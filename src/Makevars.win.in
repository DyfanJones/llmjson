TARGET = $(subst 64,x86_64,$(subst 86,i686,$(WIN)))-pc-windows-gnu
LIBDIR = ./rust/target/$(TARGET)/@LIBDIR@
STATLIB = $(LIBDIR)/libllmjson.a
PKG_LIBS = -L$(LIBDIR) -lllmjson -lws2_32 -ladvapi32 -luserenv -lbcrypt -lntdll

CARGO_HOME = $(CURDIR)/.cargo
export CARGO_HOME

all: C_clean

$(SHLIB): $(STATLIB)

CARGOTMP = $(CURDIR)/.cargo

$(STATLIB):
	if [ "$(NOT_CRAN)" != "true" ]; then \
		if [ -f ./rust/vendor.tar.xz ]; then \
			tar xf ./rust/vendor.tar.xz && \
			mkdir -p $(CARGOTMP) && \
			cp ./rust/vendor-config.toml $(CARGOTMP)/config.toml; \
		fi \
	fi && \
	export PATH="$(PATH):$(HOME)/.cargo/bin" && \
	cargo build @CRAN_FLAGS@ @PROFILE@ --target=$(TARGET) --manifest-path=./rust/Cargo.toml --target-dir ./rust/target
	@CLEAN_TARGET@

C_clean:
	rm -Rf $(SHLIB) $(STATLIB) $(OBJECTS) $(CARGOTMP)

clean:
	rm -Rf $(SHLIB) $(STATLIB) $(OBJECTS) rust/target $(CARGOTMP)
